<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/bootstrap-4.0.0-alpha.6.css" media="screen,projection" />
    <link type="text/css" rel="stylesheet" href="css/goboard.css" />
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!--Open links in a new window-->
    <base target="_blank">
</head>

<body>
    <nav class="navbar navbar-toggleable-md fixed-top bg-inverse">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <h3 class="text-white">Welcome to the goboard</h3>
            </li>
        </ul>
        <ul class="nav nav-pills">
            <li class="nav-item active">
                <a class="nav-link" href="#" id="settings"><i class="medium material-icons">settings</i></a>
            </li>
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" id="login"><i class="medium material-icons">account_circle</i></a>
                <div id="login-dp" class="dropdown-menu dropdown-menu-right">
                    <div id="login-welcome-auth"></div>
                    <div id="login-form-group">
                        <div class="dropdown-divider"></div>
                        <form id="login-form">
                            <div class="form-group">
                                <label for="loginInput">Login</label>
                                <input type="text" class="form-control" id="loginInput" aria-describedby="loginHelp" placeholder="Enter login">
                            </div>
                            <div class="form-group">
                                <label for="passwordInput">Password</label>
                                <input type="password" class="form-control" id="passwordInput" placeholder="Password">
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>
                </div>
            </li>
        </ul>
    </nav>
    <div class="toggler" id="left-menu">
        <h2 class="ui-widget-header ui-corner-all"> Configuration</h2>
        <form id="webuiconf">
            <div class="form-group">
                <label for="InfoInput">User Info</label>
                <input type="text" class="form-control" id="InfoInput" placeholder="">
            </div>
            <div class="form-group">
                <label for="totozServer">Totoz server</label>
                <input type="url" class="form-control" id="totozServer" placeholder="">
            </div>
        </form>
    </div>
    <!-- Primary Page Layout -->
    <div class="container">
        <div class="row">
            <div class="col s12" id="pini">
                <div id="popup"></div>
            </div>
        </div>
    </div>

    <div class="alert alert-success pos-f-t" id="success-alert" role="alert"></div>
    <div class="alert alert-danger pos-f-t" id="danger-alert" role="alert"></div>
    <footer class="footer bg-inverse">
        <div class="container">
            <form id="palmi" class="form-inline d-flex">
                <input placeholder="coin ! coin !" id="palmiInput" type="text" class="form-control align-self-stretch mr-2">
                <button type="submit" class="btn btn-default align-self-stretch" id="palmiBtn"><i class="material-icons md-18">send</i>
                </button>
            </form>
        </div>
    </footer>
    <!-- End Document  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="js/jquery-3.1.1.js"></script>
    <script type="text/javascript" src="js/tether-1.4.0.js"></script>
    <script type="text/javascript" src="js/bootstrap-4.0.0-alpha.6.js"></script>
    <script type="text/javascript" src="js/goboard.js"></script>
    <script>
        ///////////////////////////////////////////
         /// TO BE LOADED FROM EXTERNAL JSON
        var MAX_POSTS = 50;
        var PINI_REFRESH_MS = 5000;

        var BACKEND_URL = "http://localhost:8080/backend/json?id=%i";

        var TOTOZ_DEFAULT_SERVER = "http://totoz.eu/img"
        var TOTOZ_SERVER = ""

         ///////////////////////////////////////////
        var maxId = 0;
        var firstLoad = true;
        var intervalID;

        $(function() {
            $("#palmi").submit(function(e) {
                post_msg(e);
                e.preventDefault();
            });

            $("#pini").on({
                click: function(e) {
                    let id = e.target.id;
                    let parts = id.split("-");

                    let norloge = parts[0].replace(/_/g, ':').replace(/^t/, '');
                    if (parts.length >= 2 && parts[1] > 1) {
                        switch (parts[1]) {
                            case "1":
                                norloge += "¹";
                                break;
                            case "2":
                                norloge += "²";
                                break;
                            case "3":
                                norloge += "³";
                                break;
                            default:
                                norloge += "^" + parts[1];
                        }
                    }

                    postClockClicked(norloge);
                },
                mouseenter: function(e) {
                    let id = e.target.id;
                    let parts = id.split("-");
                    let norloge = parts[0];

                    let nindex = '';
                    let query_strs = [];
                    if (parts.length >= 2 && parts[1] > 1) {
                        nindex = parts[1];
                        query_strs.push(norloge + '-i' + nindex)
                    } else {
                        query_strs.push(norloge)
                        query_strs.push(norloge + '-i1')

                    }

                    query_strs.forEach(function(e) {
                        $("#pini").find("span[id$=" + e + "]").each(function(index) {
                            if ($(this).hasClass('clock_ref')) {
                                $(this).addClass("highlighted");
                            } else {
                                $(this).parent().addClass("highlighted");
                            }
                        });
                    });
                },
                mouseleave: function(e) {
                    $("#pini").find(".highlighted").each(function(index) {
                        $(this).removeClass("highlighted");
                    });
                    $("#pini").find(".highlighted").each(function(index) {
                        $(this).removeClass("highlighted");
                    });
                }
            }, ".post_clock");

            $("#pini").on({
                mouseenter: function(e) {
                    let q = document.querySelectorAll(":hover");
                    let totozTxt = q[q.length - 1].innerText.slice(2, -1); // Surrounding "[:" & "]"

                    let totozSrv = (TOTOZ_SERVER) ? TOTOZ_SERVER : TOTOZ_DEFAULT_SERVER;

                    let popup = $("#popup");
                    if (popup.is(':visible')) {
                        popup.hide();
                    }

                    let oImg = document.createElement("img");
                    oImg.setAttribute('src', totozSrv + '/' + encodeURI(totozTxt));
                    oImg.setAttribute('alt', 'na');

                    let popupElt = popup[0];
                    popupElt.style.position = "absolute";
                    popupElt.style.left = e.pageX.toString() + 'px';
                    popupElt.style.top = e.pageY.toString() + 'px';
                    popup.fadeIn(500);
                    while (popupElt.firstChild) {
                        popupElt.removeChild(popupElt.firstChild);
                    }
                    popupElt.appendChild(oImg)
                    e.preventDefault();
                },
                mouseleave: function(e) {
                    e.preventDefault();
                    let popup = $("#popup");
                    if (popup.is(':visible')) {
                        popup.fadeOut(200);
                    }
                    e.preventDefault();
                }
            }, ".totoz");

            $("#pini").on({
                mouseenter: function(e) {
                    let meta = $("span.norloge_ref_meta", e.target);
                    let nparts = meta[0].innerText.split("|");
                    let ntime = nparts[1].replace(/:/g, "_");
                    let nindex = nparts[2];
                    let query_str = 't' + ntime + (nindex ? '-i' + nindex : '');

                    $("#pini").find("span[id*=" + query_str + "]").each(function(index) {
                        if ($(this).hasClass('clock_ref')) {
                            $(this).addClass("highlighted");
                        } else {
                            $(this).parent().addClass("highlighted");
                        }
                    });
                },
                mouseleave: function(e) {
                    $("#pini").find(".highlighted").each(function(index) {
                        $(this).removeClass("highlighted");
                    });
                    $("#pini").find(".highlighted").each(function(index) {
                        $(this).removeClass("highlighted");
                    });
                }
            }, ".clock_ref");

            if (typeof TOTOZ_DEFAULT_SERVER === 'string') {
                $("#totozServer")[0].placeholder = TOTOZ_DEFAULT_SERVER;
            }

            $("#pini").on("mouseenter", ".clock_ref", function(e) {
                return false;
            });

            $("#settings").on("click", function(e) {
                if ($('#left-menu').is(':visible')) {
                    $('#left-menu').animate({
                        'width': '0px'
                    }, 'slow', function() {
                        $('#left-menu').hide();
                    });
                } else {
                    $('#left-menu').show();
                    $('#left-menu').animate({
                        'width': '350px'
                    }, 'slow');
                }
                e.preventDefault();
            });

            $("#login-form").submit(function(e) {
                login(e);
                e.preventDefault();
            });

            $("#login-dp").on("click", "a", function(e) {
                logout(e);
                e.preventDefault();
            })

            $("#success-alert").hide();
            $("#danger-alert").hide();

            whoami();
            update_pini();
            // Launch pini periodic refresh
            intervalID = setInterval(update_pini, PINI_REFRESH_MS);
        })
    </script>
</body>

</html>

